# ðŸš€ SAIMOR AI Business Platform - Caddy Configuration
# Automatic HTTPS with Let's Encrypt

{$DOMAIN:api.saimor.world} {
    # Security headers
    header {
        # Security
        Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
        X-Content-Type-Options "nosniff"
        X-Frame-Options "SAMEORIGIN"
        X-XSS-Protection "1; mode=block"
        Referrer-Policy "strict-origin-when-cross-origin"

        # CORS for API
        Access-Control-Allow-Origin "*"
        Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS"
        Access-Control-Allow-Headers "Content-Type, Authorization, X-API-Key"
        Access-Control-Max-Age "86400"
    }

    # Handle preflight requests
    @options method OPTIONS
    respond @options 204

    # API Gateway Routes
    handle_path /api/* {
        reverse_proxy gateway:8000
    }

    # Health endpoint (public)
    handle_path /health {
        reverse_proxy gateway:8000
    }

    # API Documentation
    handle_path /docs* {
        reverse_proxy gateway:8000
    }

    # OpenAPI Schema
    handle_path /openapi.json {
        reverse_proxy gateway:8000
    }

    # N8N Webhook routes
    handle_path /n8n/* {
        reverse_proxy n8n:5678
    }

    # Monitoring dashboard (protected)
    handle_path /monitoring* {
        reverse_proxy monitoring:3000
    }

    # Default response for root
    handle / {
        respond "ðŸš€ SAIMOR AI Business Platform - Production Ready" 200 {
            close
        }
    }

    # Logging
    log {
        output file /var/log/caddy/access.log
        format json
        level INFO
    }

    # Rate limiting
    rate_limit {
        zone api_zone {
            key {remote_host}
            events 100
            window 1m
        }
    }
}