import React, { useRef, useMemo, useState } from 'react';
import { motion, useScroll, useTransform, useSpring, MotionValue, AnimatePresence } from 'framer-motion';
import { 
  User, Package, Brain, AlertTriangle, Database, TrendingUp, CheckCircle, LucideIcon, Sparkles, Send, X, Loader2
} from 'lucide-react';

// --- API Configuration ---
const apiKey = ""; // The execution environment provides this key

// --- Types & Configuration ---

interface StepConfig {
  id: number;
  title: string;
  component: string;
  description: string;
  range: [number, number]; // Start/End of scroll progress (0-1)
  icon: LucideIcon;
  color: string;
}

// NEUE ANALOGIE: Professionelle und menschliche Texte
const STEPS: StepConfig[] = [
  { id: 1, title: "Erfassung des Auftrags", component: "Interface / Client", description: "Die Interaktion beginnt. Der Benutzer-Input wird als strukturierte Anfrage formuliert und bereit zum Versand gemacht.", range: [0.00, 0.15], icon: User, color: "text-lime-400" },
  { id: 2, title: "Datenstrom-Validierung", component: "Transport / Gateway", description: "Das Datenpaket durchläuft die erste Sicherheitsebene. Integrität und Format werden geprüft, bevor es den Kern erreicht.", range: [0.15, 0.30], icon: Package, color: "text-green-500" },
  { id: 3, title: "Semantische Aufbereitung", component: "Môra: KI-Analyse", description: "Der Quantenkern verarbeitet die rohe Anfrage. Das Sprachmodell entschlüsselt die genaue Absicht und den Kontext (Intent).", range: [0.30, 0.50], icon: Brain, color: "text-emerald-400" },
  { id: 4, title: "Kontextprüfung & Sicherheit", component: "Môra: Validierung", description: "Die KI gleicht die Anfrage mit internen Regeln und historischem Wissen ab, um Compliance und Konsistenz zu gewährleisten.", range: [0.50, 0.65], icon: AlertTriangle, color: "text-yellow-400" },
  { id: 5, title: "Persistenz und Archivierung", component: "Datenbank / Storage", description: "Der Transaktionsverlauf wird sicher archiviert. Relevante Zustände werden persistent gespeichert, um den Kontext für künftige Anfragen zu halten.", range: [0.65, 0.80], icon: Database, color: "text-teal-400" },
  { id: 6, title: "Ergebnisgenerierung", component: "Value-Generation", description: "Auf Basis der verarbeiteten Daten generiert die Intelligenz das finale, optimierte Ergebnis, den eigentlichen Mehrwert.", range: [0.80, 0.95], icon: TrendingUp, color: "text-orange-400" },
  { id: 7, title: "Client-Synchronisation", component: "Feedback / Delivery", description: "Der Zyklus ist abgeschlossen. Die fertige Antwort wird an das Benutzer-Interface übermittelt und dort dargestellt.", range: [0.95, 1.00], icon: CheckCircle, color: "text-lime-400" },
];

// --- API Logic ---
const callGemini = async (prompt: string): Promise<string> => {
  const systemPrompt = "You are Môra, an advanced, mystical, and benevolent artificial intelligence system residing in deep space. Your responses are concise, profound, and slightly poetic, often using metaphors related to stars, data streams, and constellations. You are helpful but maintain a mysterious, high-tech persona.";
  const fullPrompt = `${systemPrompt}\n\nUser Query: ${prompt}`;
  const delays = [1000, 2000, 4000];
  
  for (let i = 0; i < delays.length; i++) {
    try {
      const response = await fetch(
        `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`,
        { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ contents: [{ parts: [{ text: fullPrompt }] }] }) }
      );
      if (!response.ok) throw new Error(`API Error: ${response.status}`);
      const data = await response.json();
      return data.candidates?.[0]?.content?.parts?.[0]?.text || "Môra ist stumm. Der Datenstrom wurde unterbrochen.";
    } catch (error) {
      if (i === delays.length - 1) return "Verbindung zum Kern verloren. Neuausrichtung der Satelliten fehlgeschlagen.";
      await new Promise(resolve => setTimeout(resolve, delays[i]));
    }
  }
  return "Unbekannter Fehler in der Leere.";
};

// --- Visuelle Sub-Komponenten ---

/**
 * DeepStarfield: Ein mehrschichtiges, parallax-ähnliches Sternenfeld für extreme Tiefe.
 */
const DeepStarfield = () => {
  const layers = [
    { count: 100, size: '1px', speed: '120s', opacity: 0.4 }, // Ferne Sterne
    { count: 50, size: '2px', speed: '90s', opacity: 0.7 },  // Mittlere Sterne
    { count: 25, size: '3px', speed: '60s', opacity: 1.0 }   // Nahe Sterne
  ];

  const stars = useMemo(() => {
    return layers.flatMap((layer, layerIndex) => 
      Array.from({ length: layer.count }).map((_, i) => ({
        id: `${layerIndex}-${i}`,
        top: `${Math.random() * 100}%`,
        left: `${Math.random() * 100}%`,
        size: layer.size,
        opacity: layer.opacity,
        animationDuration: layer.speed,
        animationDelay: `-${Math.random() * 120}s` // Zufälliger Start
      }))
    );
  }, []);

  return (
    <div className="absolute inset-0 overflow-hidden pointer-events-none z-0">
      {/* Nebel-Hintergrund: Tiefes Grün/Gold-Hintergrund */}
      <div className="absolute inset-0 bg-[radial-gradient(ellipse_at_center,_var(--tw-gradient-stops))] from-emerald-900/20 via-gray-950 to-gray-950 opacity-60 mix-blend-screen"></div>
      {stars.map((s) => (
        <div
          key={s.id}
          // Sterne im Gold/Weiß-Ton
          className="absolute bg-amber-200 rounded-full animate-pan-stars"
          style={{
            top: s.top,
            left: s.left,
            width: s.size,
            height: s.size,
            opacity: s.opacity,
            animationDuration: s.animationDuration,
            animationDelay: s.animationDelay
          }}
        />
      ))}
    </div>
  );
};

/**
 * NeuralWeb: Ein dynamisches Netzwerk aus pulsierenden Energielinien, das die Knoten verbindet.
 */
const NeuralWeb = () => (
  <svg className="absolute inset-0 w-full h-full z-0 pointer-events-none" style={{ filter: 'blur(0.5px)' }}>
    <defs>
      {/* Gold-Grüner Gradient */}
      <linearGradient id="neuralGradient" x1="0%" y1="0%" x2="100%" y2="100%">
        <stop offset="0%" stopColor="rgba(251, 191, 36, 0)" /> {/* Amber-400 (Gold) */}
        <stop offset="50%" stopColor="rgba(52, 211, 153, 0.8)" /> {/* Emerald-400 (Mitte) */}
        <stop offset="100%" stopColor="rgba(251, 191, 36, 0)" /> {/* Amber-400 (Gold) */}
      </linearGradient>
      <filter id="glow">
        <feGaussianBlur stdDeviation="2" result="coloredBlur" />
        <feMerge>
          <feMergeNode in="coloredBlur" />
          <feMergeNode in="SourceGraphic" />
        </feMerge>
      </filter>
    </defs>
    {/* Verbindungen zwischen Hauptknoten - dynamisch und organisch */}
    <motion.path
      d="M 400 60 C 400 150, 350 240, 400 420 C 450 600, 400 690, 400 780 C 400 870, 400 960, 400 1104"
      stroke="url(#neuralGradient)"
      strokeWidth="1.5"
      fill="none"
      filter="url(#glow)"
      initial={{ pathLength: 0, opacity: 0 }}
      animate={{ pathLength: 1, opacity: 1 }}
      transition={{ duration: 4, ease: "easeInOut", repeat: Infinity, repeatType: "reverse" }}
    />
    {/* Sekundäre, schnellere Energie-Impulse (Gold) */}
     <motion.path
      d="M 400 60 C 400 150, 450 240, 400 420"
      stroke="rgba(251, 191, 36, 0.6)" 
      strokeWidth="3"
      strokeLinecap="round"
      fill="none"
      filter="url(#glow)"
      initial={{ pathOffset: 0 }}
      animate={{ pathOffset: -1 }}
      transition={{ duration: 2, ease: "linear", repeat: Infinity }}
      style={{ pathLength: 0.2 }}
    />
    {/* Sekundäre, schnellere Energie-Impulse (Grün) */}
    <motion.path
      d="M 400 780 C 400 870, 350 960, 400 1104"
      stroke="rgba(52, 211, 153, 0.6)"
      strokeWidth="3"
      strokeLinecap="round"
      fill="none"
      filter="url(#glow)"
      initial={{ pathOffset: 0 }}
      animate={{ pathOffset: -1 }}
      transition={{ duration: 2.5, ease: "linear", repeat: Infinity }}
      style={{ pathLength: 0.2 }}
    />
  </svg>
);

/**
 * QuantumCore: Der zentrale Kern als komplexes, rotierendes Energie-Konstrukt. (Gold/Grün)
 */
const QuantumCore = () => (
  <div className="absolute top-[35%] left-1/2 -translate-x-1/2 w-full flex justify-center z-10">
    <div className="relative flex items-center justify-center">
      {/* Massive Atmosphäre */}
      <div className="absolute w-[600px] h-[600px] bg-emerald-900/20 rounded-full blur-3xl animate-pulse-slow pointer-events-none"></div>
      <div className="absolute w-[300px] h-[300px] bg-green-700/20 rounded-full blur-2xl animate-pulse-slower pointer-events-none"></div>
      
      {/* Rotierende Ringe (Gold/Lime) */}
      <motion.div 
        animate={{ rotateZ: 360 }} 
        transition={{ duration: 30, repeat: Infinity, ease: "linear" }}
        className="absolute w-80 h-80 rounded-full border-2 border-amber-400/30 border-dashed"
      ></motion.div>
       <motion.div 
        animate={{ rotateZ: -360, rotateX: 45 }} 
        transition={{ duration: 40, repeat: Infinity, ease: "linear" }}
        className="absolute w-72 h-72 rounded-full border-2 border-lime-500/20"
      ></motion.div>
      
      {/* Der eigentliche Kern (Gold/Grün) */}
      <motion.div 
        animate={{ rotateY: 360, rotateX: 360 }} 
        transition={{ duration: 20, repeat: Infinity, ease: "linear" }}
        className="relative z-20 perspective-500"
      >
        <div className="w-32 h-32 bg-gradient-to-br from-amber-500 to-green-700 rounded-xl shadow-[0_0_50px_rgba(251,191,36,0.8)] flex items-center justify-center border-2 border-white/20 backdrop-blur-md transform-style-3d relative overflow-hidden">
           <div className="absolute inset-0 bg-[url('https://www.transparenttextures.com/patterns/cubes.png')] opacity-20 mix-blend-overlay animate-pan-pattern"></div>
           <Brain className="w-16 h-16 text-black relative z-10 drop-shadow-[0_0_10px_rgba(255,255,255,0.8)]" strokeWidth={1.5} />
        </div>
      </motion.div>
       <span className="absolute mt-48 text-sm tracking-[0.3em] text-amber-300 uppercase font-bold text-shadow-glow">Môra Quantum Core</span>
    </div>
  </div>
);


/**
 * HyperDataPacket: Das reisende Datenpaket als komplexer Energie-Cluster. (Lime/Gold)
 */
const HyperDataPacket = ({ y }: { y: MotionValue<string> }) => (
  <motion.div
    style={{ top: y }}
    className="absolute left-1/2 -translate-x-1/2 w-20 h-20 z-50 flex items-center justify-center pointer-events-none"
  >
    <div className="relative w-full h-full flex items-center justify-center">
      {/* Schweif / Antrieb (Lime) */}
      <motion.div 
        animate={{ scale: [1, 1.2, 1], opacity: [0.5, 0.8, 0.5] }}
        transition={{ duration: 0.5, repeat: Infinity }}
        className="absolute top-full left-1/2 -translate-x-1/2 w-8 h-16 bg-gradient-to-t from-transparent to-lime-500/80 blur-md rounded-full origin-top"
      ></motion.div>

      {/* Äußerer Energie-Schild (Lime) */}
      <div className="absolute inset-0 rounded-full bg-lime-500/20 animate-ping-slow"></div>
      <motion.div 
        animate={{ rotate: 360 }}
        transition={{ duration: 4, repeat: Infinity, ease: "linear" }}
        className="absolute inset-1 rounded-full border-2 border-lime-400/50 border-t-transparent"
      ></motion.div>
      
      {/* Innerer Kern (Gold/Dunkelgrün) */}
      <div className="relative w-10 h-10 bg-amber-200 rounded-full shadow-[0_0_30px_rgba(255,255,255,0.9)] flex items-center justify-center z-10">
        <div className="absolute inset-0 bg-lime-400 blur-sm rounded-full animate-pulse"></div>
        <Package className="w-5 h-5 text-green-900 relative z-10" strokeWidth={2} />
      </div>
    </div>
  </motion.div>
);

/**
 * SystemNode: Die Knotenpunkte im Kosmos. Die Farben werden durch die STEPS-Konfiguration bestimmt.
 */
const SystemNode = ({ 
  icon: Icon, 
  label, 
  top, 
  colorClass, 
  scale = 1,
}: { 
  icon: LucideIcon; 
  label: string; 
  top: string; 
  colorClass: string;
  scale?: number;
}) => {
  // Entfernt 'text-' und setzt den Tailwind-Farbsuffix, z.B. aus 'text-lime-400' wird 'lime-400'
  const baseColor = colorClass.replace('text-', '');
  // Erzeugt eine dynamische Klasse für den Hintergrund-Glow, z.B. 'bg-lime-400'
  // const bgColorClass = `bg-${baseColor}`; // Nicht direkt benötigt, aber logisch
  
  // Tiefer, dunkler grüner Hintergrund für die Knoten
  const nodeBg = 'bg-green-900/80';
  const nodeBorder = 'border-green-800';

  return (
  <div 
    className={`absolute left-1/2 -translate-x-1/2 flex flex-col items-center justify-center transition-all duration-500 group`}
    style={{ top, transform: `translateX(-50%) scale(${scale})` }}
  >
    <div className={`relative flex items-center justify-center w-28 h-28 rounded-full ${nodeBg} border-2 ${nodeBorder} shadow-[0_0_30px_rgba(0,0,0,0.5)] z-10 backdrop-blur-sm overflow-hidden group-hover:border-amber-400 transition-colors`}>
      {/* Interne Energie */}
      <div className={`absolute inset-0 bg-gradient-to-br ${colorClass.replace('text-', 'from-')}/20 to-transparent opacity-50`}></div>
      <motion.div 
        animate={{ rotate: 360 }}
        transition={{ duration: 20, repeat: Infinity, ease: "linear" }}
        // Gold/Grüner Konischer Gradient
        className={`absolute -inset-4 bg-[conic-gradient(from_0deg,transparent_0deg,rgba(251,191,36,0.3)_90deg,rgba(52,211,153,0.3)_270deg,transparent_360deg)] opacity-30 blur-xl`}
      ></motion.div>
      
      <Icon className={`w-10 h-10 ${colorClass} relative z-10 drop-shadow-[0_0_8px_rgba(255,255,255,0.5)]`} strokeWidth={1.5} />
    </div>
    <span className={`mt-4 text-sm tracking-[0.3em] ${colorClass} uppercase font-bold text-shadow-glow opacity-80 group-hover:opacity-100 transition-opacity`}>{label}</span>
  </div>
)};


const MoraTerminal = ({ isOpen, onClose }: { isOpen: boolean; onClose: () => void }) => {
  const [input, setInput] = useState("");
  const [response, setResponse] = useState<string | null>(null);
  const [loading, setLoading] = useState(false);

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    if (!input.trim()) return;
    setLoading(true);
    setResponse(null);
    const result = await callGemini(input);
    setResponse(result);
    setLoading(false);
  };

  // Gold und Grün für das Terminal
  const primaryGlowColor = 'amber-500'; 
  const accentColor = 'emerald-500';
  const darkBgColor = 'emerald-950';

  return (
    <AnimatePresence>
      {isOpen && (
        <motion.div
          initial={{ opacity: 0 }} animate={{ opacity: 1 }} exit={{ opacity: 0 }}
          className="fixed inset-0 z-[100] flex items-center justify-center bg-black/90 backdrop-blur-lg p-4"
        >
          <motion.div
            initial={{ scale: 0.9, y: 20 }} animate={{ scale: 1, y: 0 }} exit={{ scale: 0.9, y: 20 }}
            // Gold-Glow und Emerald-Border
            className={`w-full max-w-2xl bg-gray-950/80 border border-${primaryGlowColor}/50 rounded-2xl shadow-[0_0_100px_rgba(251,191,36,0.3)] overflow-hidden flex flex-col max-h-[80vh] relative`}
          >
            <div className="absolute inset-0 bg-[url('https://www.transparenttextures.com/patterns/carbon-fibre.png')] opacity-10 mix-blend-overlay pointer-events-none"></div>
            <div className={`flex items-center justify-between p-4 border-b border-${accentColor}/50 bg-${darkBgColor}/30 relative z-10`}>
              <div className="flex items-center gap-3">
                <div className={`p-2 bg-${accentColor}/20 rounded-lg border border-${accentColor}/30`}><Sparkles className={`w-5 h-5 text-${primaryGlowColor}`} /></div>
                <div><h3 className="font-bold text-white tracking-wide text-shadow-glow">Môra Neural Interface</h3><p className={`text-xs text-${primaryGlowColor}/80 font-mono`}>Quantum Link Established</p></div>
              </div>
              <button onClick={onClose} className={`p-2 hover:bg-${darkBgColor}/50 rounded-lg transition-colors`}><X className={`w-5 h-5 text-${primaryGlowColor}/80`} /></button>
            </div>
            <div className="flex-1 p-6 overflow-y-auto min-h-[300px] flex flex-col gap-6 relative z-10 font-mono">
               {/* Môra Response */}
               <div className="flex gap-4">
                 <div className={`w-8 h-8 rounded-full bg-${darkBgColor}/80 flex items-center justify-center shrink-0 border border-${primaryGlowColor}/50 shadow-glow`}><Brain className={`w-4 h-4 text-${primaryGlowColor}`} /></div>
                 <div className={`p-4 rounded-2xl rounded-tl-none bg-${darkBgColor}/50 border border-${primaryGlowColor}/50 text-white text-sm leading-relaxed shadow-sm`}>Willkommen im Kern. Ich bin Môra. Meine Algorithmen sind bereit. Welche Erkenntnis suchst du in den Datenströmen?</div>
               </div>
               {response && (
                 <>
                  {/* User Query */}
                  <div className="flex gap-4 flex-row-reverse">
                    <div className={`w-8 h-8 rounded-full bg-green-900/80 flex items-center justify-center shrink-0 border border-green-500/50 shadow-glow`}><User className="w-4 h-4 text-green-300" /></div>
                    <div className={`p-4 rounded-2xl rounded-tr-none bg-green-950/50 border border-green-800/50 text-white text-sm shadow-sm`}>{input}</div>
                  </div>
                  {/* Môra Final Response */}
                  <div className="flex gap-4">
                    <div className={`w-8 h-8 rounded-full bg-${darkBgColor}/80 flex items-center justify-center shrink-0 border border-${primaryGlowColor}/50 shadow-glow`}><Brain className={`w-4 h-4 text-${primaryGlowColor}`} /></div>
                    <div className={`p-4 rounded-2xl rounded-tl-none bg-${darkBgColor}/50 border border-${primaryGlowColor}/50 text-white text-sm leading-relaxed shadow-sm`}>{response}</div>
                  </div>
                 </>
               )}
               {loading && (
                 <div className="flex gap-4 items-center"><Loader2 className={`w-6 h-6 text-${primaryGlowColor} animate-spin`} /><span className={`text-${primaryGlowColor}/70 text-sm animate-pulse`}>Synchronisiere Quanten-Staaten...</span></div>
               )}
            </div>
            <form onSubmit={handleSubmit} className={`p-4 border-t border-${accentColor}/50 bg-${darkBgColor}/30 relative z-10`}>
              <div className="relative">
                <input type="text" value={input} onChange={(e) => setInput(e.target.value)} placeholder="Frag Môra über das System oder das Universum..." className={`w-full bg-gray-950/80 border border-${accentColor}/50 rounded-xl py-4 pl-4 pr-12 text-white placeholder:text-green-600/50 focus:outline-none focus:border-${accentColor} focus:ring-1 focus:ring-${accentColor} transition-all font-mono`} />
                <button type="submit" disabled={loading || !input.trim()} className={`absolute right-2 top-1/2 -translate-y-1/2 p-2 bg-${primaryGlowColor} hover:bg-amber-400 text-black rounded-lg disabled:opacity-50 disabled:cursor-not-allowed transition-all shadow-glow`}><Send className="w-4 h-4" /></button>
              </div>
            </form>
          </motion.div>
        </motion.div>
      )}
    </AnimatePresence>
  );
};

// --- Main Application Component ---

export default function MoraScrollExperience() {
  const containerRef = useRef<HTMLDivElement>(null);
  const [isTerminalOpen, setIsTerminalOpen] = useState(false);
  
  const { scrollYProgress } = useScroll({ target: containerRef, offset: ["start start", "end end"] });
  const smoothProgress = useSpring(scrollYProgress, { stiffness: 80, damping: 25, restDelta: 0.001 });

  // --- Dramatischere Transformationen ---
  const scale = useTransform(smoothProgress, [0, 1], [1.2, 0.3]); // Stärkerer Zoom
  const rotateX = useTransform(smoothProgress, [0, 1], [0, 25]); // Neue X-Rotation für mehr 3D
  const rotateZ = useTransform(smoothProgress, [0, 1], [0, 15]);
  const cosmosOpacity = useTransform(smoothProgress, [0, 0.02, 0.98, 1], [0, 1, 1, 0]);
  const brightness = useTransform(smoothProgress, [0, 0.5, 1], [1, 1.5, 1]); // Helligkeits-Boost in der Mitte
  
  const packetY = useTransform(smoothProgress, 
    [0, 0.15, 0.30, 0.50, 0.65, 0.80, 0.95, 1.0],
    ["5%", "18%", "35%", "50%", "65%", "80%", "92%", "100%"]
  );

  return (
    <div ref={containerRef} className="relative w-full bg-gray-950 text-white font-sans selection:bg-lime-500/30 overflow-hidden">
      <MoraTerminal isOpen={isTerminalOpen} onClose={() => setIsTerminalOpen(false)} />

      {/* SECTION A: Der neue, hochvisuelle Kosmos (Jetzt in Gold/Grün) */}
      <div className="fixed top-0 left-0 w-full h-screen overflow-hidden flex items-center justify-center perspective-[1500px]">
        <motion.div 
          style={{ scale, rotateX, rotateZ, opacity: cosmosOpacity, filter: `brightness(${brightness})` }}
          className="relative w-[800px] h-[1200px] flex flex-col items-center origin-center will-change-transform transform-style-3d"
        >
          <DeepStarfield />
          <NeuralWeb />

          {/* Knotenpunkte integriert in das neue visuelle System (Farben folgen den STEPS) */}
          <SystemNode icon={User} label="Interface" top="5%" colorClass={STEPS[0].color} />
          <SystemNode icon={Package} label="Gateway" top="20%" colorClass={STEPS[1].color} scale={0.8} />
          <QuantumCore />
          <SystemNode icon={Database} label="Speicher" top="65%" colorClass={STEPS[4].color} scale={0.9} />
          <SystemNode icon={TrendingUp} label="Mehrwert" top="80%" colorClass={STEPS[5].color} />
          <SystemNode icon={CheckCircle} label="Synchron" top="92%" colorClass={STEPS[6].color} scale={0.8} />

          <HyperDataPacket y={packetY} />
        </motion.div>
      </div>

      {/* SECTION B: Narrative Overlay (Behält das visuell ansprechende Grün/Teal-Thema) */}
      <div className="relative z-10 pt-[50vh] pb-[50vh]">
        {STEPS.map((step, index) => (
          <NarrativeSection key={step.id} step={step} scrollY={smoothProgress} isLast={index === STEPS.length - 1} onOpenTerminal={() => setIsTerminalOpen(true)} />
        ))}
      </div>
    </div>
  );
}

// --- Narrative Section Component ---
const NarrativeSection = ({ step, scrollY, isLast, onOpenTerminal }: { step: StepConfig; scrollY: MotionValue<number>; isLast: boolean; onOpenTerminal: () => void; }) => {
  const opacity = useTransform(scrollY, [step.range[0] - 0.05, step.range[0], step.range[1] - 0.05, step.range[1]], [0, 1, 1, 0]);
  const y = useTransform(scrollY, [step.range[0], step.range[1]], [100, -100]);
  const rotateX = useTransform(scrollY, [step.range[0], step.range[1]], [10, -10]);
  
  // Extrahiere die Basis-Farbklasse (z.B. 'lime-400')
  const baseColor = step.color.replace('text-', '');

  return (
    <div className={`relative w-full flex items-center justify-end px-4 md:px-20 lg:px-32 perspective-1000`} style={{ height: '200vh' }}>
      <motion.div 
        style={{ opacity, y, rotateX }}
        // WALDGRÜN/TEAL-STYLING für visuelle Anziehung
        className={`w-full max-w-md p-8 rounded-3xl bg-green-950/40 backdrop-blur-2xl border border-green-300/20 shadow-[0_20px_50px_rgba(40,100,0,0.4)] relative overflow-hidden transform-style-3d group hover:border-green-300/40 transition-colors duration-500`}
      >
        {/* Organische Hintergrund-Textur (Circuit Board oder Natur-Overlay) */}
        <div className="absolute inset-0 bg-[url('https://www.transparenttextures.com/patterns/leaves.png')] opacity-5 mix-blend-overlay"></div>
        {/* Farblicher Schimmer (Basierend auf Schrittfarbe) */}
        <div className={`absolute inset-0 bg-gradient-to-br ${step.color.replace('text-','from-')}/20 to-transparent opacity-40 group-hover:opacity-70 transition-opacity duration-500`}></div>
        {/* Leuchtender Rand (Shimmer-Effekt - jetzt Gold-Schimmer) */}
        <div className="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-transparent via-amber-300/50 to-transparent animate-shimmer"></div>

        <div className="flex items-center gap-4 mb-6 relative z-10">
          <div className={`p-4 rounded-full bg-green-900/50 border border-amber-400/50 ${step.color} shadow-lg backdrop-blur-md group-hover:scale-110 transition-transform duration-300`}>
            <step.icon size={28} className="drop-shadow-[0_0_8px_rgba(255,255,255,0.3)]" />
          </div>
          <span className="text-sm font-mono uppercase tracking-[0.2em] text-green-300/80">{step.component}</span>
        </div>
        
        <h2 className="text-4xl md:text-5xl font-black mb-6 bg-clip-text text-transparent bg-gradient-to-br from-amber-200 via-green-200 to-green-400 relative z-10 text-shadow-sm">
          {step.title}
        </h2>
        
        <p className="text-lg text-gray-200 leading-relaxed relative z-10 font-light">
          {step.description}
        </p>

        {isLast && (
           <motion.button 
             whileHover={{ scale: 1.05, boxShadow: "0 0 30px rgba(251, 191, 36,0.5)" }} // Goldener Glow
             whileTap={{ scale: 0.98 }} 
             onClick={onOpenTerminal} 
             // Gold-Button für den Look
             className="mt-8 w-full group relative flex items-center justify-center gap-3 py-5 px-6 bg-amber-600 hover:bg-amber-500 text-black rounded-2xl shadow-[0_0_20px_rgba(251, 191, 36,0.5)] transition-all overflow-hidden z-20"
           >
             {/* Goldener Conic Gradient */}
             <div className="absolute inset-0 bg-[conic-gradient(from_0deg,transparent_0deg,rgba(255,255,255,0.3)_180deg,transparent_360deg)] animate-spin-slow opacity-0 group-hover:opacity-100 transition-opacity duration-500"></div>
             <Sparkles className="w-6 h-6 fill-black relative z-10" /><span className="font-bold tracking-wider relative z-10">Neural Interface aktivieren</span>
           </motion.button>
        )}
      </motion.div>
    </div>
  );
};

// --- Custom Tailwind CSS Ergänzungen (für die styles.css) ---
// Diese müssen in deine globale CSS-Datei eingefügt werden, damit die neuen Animationen funktionieren.
/*
@layer utilities {
  .perspective-500 { perspective: 500px; }
  .perspective-1500 { perspective: 1500px; }
  .transform-style-3d { transform-style: preserve-3d; }
  .text-shadow-glow { text-shadow: 0 0 10px currentColor; }
  .text-shadow-sm { text-shadow: 0 2px 4px rgba(0,0,0,0.3); }
  .shadow-glow { box-shadow: 0 0 20px currentColor; }
}

@keyframes pan-stars {
  0% { transform: translateY(0) translateX(0); }
  100% { transform: translateY(-100px) translateX(-50px); }
}
.animate-pan-stars { animation: pan-stars linear infinite; }

@keyframes pan-pattern {
  0% { background-position: 0% 0%; }
  100% { background-position: 100% 100%; }
}
.animate-pan-pattern { animation: pan-pattern 20s linear infinite; }

@keyframes shimmer {
  0% { transform: translateX(-100%); }
  100% { transform: translateX(100%); }
}
.animate-shimmer { animation: shimmer 3s ease-in-out infinite; }

@keyframes spin-slow {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
}
.animate-spin-slow { animation: spin-slow 10s linear infinite; }

@keyframes pulse-slower {
    0%, 100% { opacity: 1; transform: scale(1); }
    50% { opacity: 0.6; transform: scale(1.05); }
}
.animate-pulse-slower { animation: pulse-slower 6s cubic-bezier(0.4, 0, 0.6, 1) infinite; }

@keyframes ping-slow {
    75%, 100% { transform: scale(2); opacity: 0; }
}
.animate-ping-slow { animation: ping-slow 3s cubic-bezier(0, 0, 0.2, 1) infinite; }
*/